window.newModule="core.$firebase",angular.module(window.newModule,["firebase","myApp.config"]).factory("$firebase",["FBURL","config","fbutil","$firebaseObject","$q","snippet",function(FBURL,config,fbutil,$firebaseObject,$q,snippet){function FbObj(a,b){function e(){return void 0!==c.keepOnline?!!c.keepOnline:void 0!==d.keepOnline?!!d.keepOnline:!0}var c=b||{},d=$firebase.databases[a.split("@")[1]]||{};this.dbName=d.Name||FBURL.split("//")[1].split(".fi")[0],this.dbUrl="https://"+this.dbName+".firebaseio.com",this.path=a.split("@")[0],this.url=this.dbUrl+"/"+this.path,this.t=(new Date).getTime().toString(),this.params=c.params||{},this.keepOnline=e()}function ref(a,b){var c=new FbObj(a,b);return c.ref()}function $object(a){return objectRepo[a]?objectRepo[a]:(objectRepo[a]=$firebaseObject(ref(a)),objectRepo[a])}function Digest(a,b,c,d){var e;this.reset=function(f,g){void 0!=e&&clearTimeout(e),e=setTimeout(function(){f&&f.apply(null),c||b.goOffline(),a&&a.$digest()},g||d)}}function load(refUrl,rule,extraOnComplete,finalOnComplete){function RefObj(a,b){function e(a,b,c){return config.debug&&console.log("load complete",JSON.stringify(a.val())),digest.reset(function(){"function"==typeof c&&c.apply(null),"function"==typeof finalOnComplete&&finalOnComplete.apply(null,[a,b])}),extraOnComplete?extraOnComplete(a,b):void 0}var d,c=this;a?(d="on",c.onComplete=e):(d="once","child_added"===b?(d="on",c.onComplete=function(a,b){e(a,b,function(){queryRef.off("child_added",c.onComplete)})}):c.onComplete=e),c.evalString="queryRef."+d+"('"+b+"', onComplete, errorCallback)"}function errorCallback(a){console.log("Fail to load "+refUrl+": "+a.code),fbObj.goOffline()}var fbObj=new FbObj(refUrl),query=rule&&rule.query?"."+rule.query:"",isSync=rule&&rule.isSync||!0,eventType=rule&&rule.eventType||"value",scope=rule&&rule.scope,delay=rule&&rule.delay||300,ref=fbObj.ref(),queryRef=eval("ref"+query),digest=new Digest(scope,fbObj,isSync,delay);fbObj.goOnline();var refObj=new RefObj(isSync,eventType),onComplete=refObj.onComplete;digest.reset(null,5e3),eval(refObj.evalString)}function update(a,b,c,d,e){var f=$q.defer(),g=snippet.replaceParamsInString(a,e),h=new FbObj(g),i=h.ref(),j=d?"set":"update",k=angular.extend({},e,h.params);if("object"==typeof b&&null!=b)for(var l in k){var m=l.split("$")[1];void 0!==b[m]&&(b[m]=k[l])}else if("string"==typeof b)for(var l in k)b.replace(l,k[l]);return h.goOnline(),i[j](b,function(b){c&&c.apply(null,[b]),b?(console.log("Update failed: "+a),f.reject(b)):(config.debug&&console.log("Update success: "+a),f.resolve()),h.goOffline()}),f.promise.params=h.params,f.promise}function set(a,b,c,d){update(a,b,c,!0,d)}function batchUpdate(a,b){function f(c){var f=b?d[c]:a[c].onComplete,g=$firebase.update(a[c].refUrl,a[c].value,f,a[c].set,e).params;e=angular.extend(e,g)}function g(b,d){return function(g){return a[b]&&a[b].onComplete&&a[b].onComplete.apply(null,[g]),g?void c.reject(g):void(d?c.resolve({params:e}):f(b+1))}}var c=$q.defer(),d=[],e=snippet.cloneObject($firebase.params);if(b||void 0===b){for(var h=0;h<a.length;h++)d[h]=new g(h,h===a.length-1);f(0)}else for(var i=0;i<a.length;i++)f(i);return c.promise}function move(a,b){var c=new Firebase(a),d=new Firebase(b);c.once("value",function(a){d.update(a.val())})}function $transfer(a,b){var c=new Firebase(a.refUrl),d=new Firebase(b.refUrl),e=$q.defer();c.once("value",function(b){var c=a.modifier&&"function"==typeof modifier?a.modifier(b.val()):b.val();d.update(c,function(a){a?e.reject(a):e.resolve()})})}function $communicate(a){var b={},c=$q.defer();if("object"==typeof a)return batchUpdate(a.request,!0).then(function(d){if(!a.response)return void c.resolve(d);angular.extend(b,d);var e=snippet.replaceParamsInObj(a.response,d.params);getResponse(e).then(function(a){angular.extend(b,a),c.resolve(b)},function(a){c.reject(a)})},function(a){c.reject(a)}),c.promise}function getResponse(a){var b=Object.keys(a).length,c={},d=$q.defer(),e=new snippet.WaitUntil(b,function(){d.resolve(c)});for(var f in a)ref(a[f]).on("value",function(b){void 0!==c[f]?(c[f]=b.val(),e.resolve(),ref(a[f]).off()):c[f]=b.val()},function(a){d.reject(a)});return d.promise}function getMultipleRefVal(a,b){function n(){k=snippet.replaceParamsInObj(k,e);for(var a in g)g.hasOwnProperty(a)&&-1===k[a].indexOf(j)&&!g[a]&&(f[a]=new function(a){return function(b){"string"==typeof b.val()&&(e[j+a]=b.val()),d[a]=b.val(),delete g[a],l.resolve(),n()}}(a),g[a]=!0,ref(k[a]).once("value",f[a]))}var c=b?b:{},d={},e={},f={},g={},h=$q.defer(),i=Object.keys(a).length,j=c.indicator||"&",k=angular.extend({},a),l=new snippet.WaitUntil(i,function(){h.resolve(d)});for(var m in a)g[m]=!1;return n(),h.promise}var $firebase={FbObj:FbObj,load:load,update:update,set:set,batchUpdate:batchUpdate,params:{},databases:{},ref:ref,$communicate:$communicate,$object:$object,getMultipleRefVal:getMultipleRefVal,move:move},activeRefUrl={};FbObj.prototype={ref:function(){for(var a=new Firebase(this.dbUrl),b=this.path.split("/"),c=0;c<b.length;c++)"$"===b[c].charAt(0)?(a=a.push(),this.params[b[c]]=a.key()):a=a.child(b[c]);return this.url=a.toString(),this.path=this.url.split(".com/")[1],a},goOnline:function(){return void 0===activeRefUrl[this.dbUrl]&&(activeRefUrl[this.dbUrl]=[]),0===activeRefUrl[this.dbUrl].length&&(this.keepOnline||(Firebase.goOnline(this.dbUrl),console.log(this.dbUrl,"is online",this.t))),activeRefUrl[this.dbUrl].push(this.t),this},goOffline:function(){if(this.keepOnline)return this;void 0===activeRefUrl[this.dbUrl]&&(activeRefUrl[this.dbUrl]=[]),1===activeRefUrl[this.dbUrl].length&&(this.keepOnline||(Firebase.goOffline(this.dbUrl),console.log(this.dbUrl,"is offline",this.t)));var a=activeRefUrl[this.dbUrl].indexOf(this.t);return-1!=a&&activeRefUrl[this.dbUrl].splice(a,1),this}};var objectRepo={};return $firebase}]),window.appDI&&window.appDI.push(window.newModule);